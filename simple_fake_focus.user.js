// ==UserScript==
// @name         Simple Fake Focus
// @description  -
// @icon         https://cdn-icons-png.flaticon.com/512/172/172851.png
// @author       dannycreations
// @version      0.0.2
// @namespace    https://github.com/dannycreations/Peke
// @homepage     https://github.com/dannycreations/Peke
// @match        *://*.*/*
// @grant        none
// @run-at       document-start
// ==/UserScript==

!function(){"use strict";const t=[{target:Document.prototype,key:"hidden",spoof:{get:()=>!1,configurable:!0}},{target:Document.prototype,key:"webkitHidden",spoof:{get:()=>!1,configurable:!0}},{target:Document.prototype,key:"visibilityState",spoof:{get:()=>"visible",configurable:!0}},{target:Document.prototype,key:"webkitVisibilityState",spoof:{get:()=>"visible",configurable:!0}},{target:document,key:"hasFocus",spoof:{value:()=>!0,configurable:!0,writable:!0}},{target:window,key:"focus",spoof:{value:()=>{},configurable:!0,writable:!0}}];class e{constructor(){this.isActive=!1,this.intervalId=null,this.debounceId=null,this.audioContext=null,this.originalDescriptors=new Map;const t=()=>{try{this.isOriginalPageHidden()||!this.isOriginalPageFocused()?this.activateDebounced():this.deactivateDebounced()}catch{}};t(),window.addEventListener("blur",t,!0),window.addEventListener("focus",t,!0),document.addEventListener("visibilitychange",t,!0),document.addEventListener("webkitvisibilitychange",t,!0)}async activate(){this.isActive||(this.isActive=!0,this.manageSpoofs(!0),await this.manageSilentAudio(!0),this.intervalId=window.setInterval(()=>this.emitActivity(),6e4))}async deactivate(){this.isActive&&(this.isActive=!1,null!==this.intervalId&&(window.clearInterval(this.intervalId),this.intervalId=null),await this.manageSilentAudio(!1),this.manageSpoofs(!1))}activateDebounced(){null!==this.debounceId&&window.clearTimeout(this.debounceId),this.debounceId=window.setTimeout(()=>this.activate(),100)}deactivateDebounced(){null!==this.debounceId&&window.clearTimeout(this.debounceId),this.debounceId=window.setTimeout(()=>this.deactivate(),100)}manageSpoofs(e){if(e)for(const i of t){const{target:t,key:e,spoof:o}=i;try{const i=Object.getOwnPropertyDescriptor(t,e);this.originalDescriptors.set(e,{target:t,key:e,descriptor:i}),Object.defineProperty(t,e,o)}catch{}}else{for(const t of this.originalDescriptors.values()){const{target:e,key:i,descriptor:o}=t;try{o?Object.defineProperty(e,i,o):delete e[i]}catch{}}this.originalDescriptors.clear()}}async manageSilentAudio(t){if(t){if(!this.audioContext||"running"!==this.audioContext.state){await this.manageSilentAudio(!1);try{const t=window.AudioContext||window.webkitAudioContext;if(!t)return;if(this.audioContext=new t,"suspended"===this.audioContext.state&&await this.audioContext.resume(),"running"!==this.audioContext.state)throw new Error("AudioContext failed to start or resume.");const e=this.audioContext.createGain();e.gain.value=1e-5;const i=this.audioContext.createOscillator();i.frequency.value=20,i.connect(e).connect(this.audioContext.destination),i.start()}catch{await this.manageSilentAudio(!1)}}}else if(this.audioContext){try{"closed"!==this.audioContext.state&&await this.audioContext.close()}catch{}this.audioContext=null}}emitActivity(){try{const t=new KeyboardEvent("keyup",{key:"F32",code:"F32",which:143,keyCode:143,bubbles:!0,cancelable:!0});document.dispatchEvent(t)}catch{}}isOriginalPageHidden(){if(!this.isActive)return document.hidden;const t=this.originalDescriptors.get("hidden");if(!t?.descriptor?.get)return!1;try{return t.descriptor.get.call(document)}catch{return!1}}isOriginalPageFocused(){if(!this.isActive)return document.hasFocus();const t=this.originalDescriptors.get("hasFocus");if("function"!=typeof t?.descriptor?.value)return!0;try{return t.descriptor.value.call(document)}catch{return!0}}}(()=>{new e})()}();